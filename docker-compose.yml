# ──────────────────────────────────────────────────────────────
# Docker Compose - Travel Planner Infrastructure
# ──────────────────────────────────────────────────────────────
# Services (7):
#   - ollama:            LLM inference server (GPU/CPU)
#   - ollama-init:       One-shot model pull
#   - mcp-server:        FastMCP travel tools (Streamable HTTP, port 8090)
#   - aspire-dashboard:  .NET Aspire Dashboard (traces + metrics + logs)
#   - api:               FastAPI REST + SSE server (port 8000)
#   - frontend:          React/Next.js web UI (port 3000)
#   - postgres:          PostgreSQL conversation persistence
#
# Usage:
#   docker compose --profile gpu up -d    # Start with GPU
#   docker compose --profile cpu up -d    # Start CPU-only
#   docker compose down                   # Stop services
#   docker compose logs -f                # Follow logs
#
# Access:
#   Web UI:    http://localhost:3000
#   API:       http://localhost:8000/api/health
#   Aspire:    http://localhost:18888
#   MCP:       http://localhost:8090/health
# ──────────────────────────────────────────────────────────────

services:
  # ── Ollama (GPU mode) ──────────────────────────────────────
  ollama-gpu:
    image: ollama/ollama:latest
    container_name: travel-ollama
    profiles: ["gpu"]
    ports:
      - "11434:11434"
    volumes:
      - ollama-models:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - OLLAMA_LLM_LIBRARY=cuda_v12
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "ollama", "list"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ── Ollama (CPU mode) ──────────────────────────────────────
  ollama-cpu:
    image: ollama/ollama:latest
    container_name: travel-ollama
    profiles: ["cpu"]
    ports:
      - "11434:11434"
    volumes:
      - ollama-models:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "ollama", "list"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ── Ollama Model Init (one-shot) ───────────────────────────
  ollama-init:
    image: ollama/ollama:latest
    container_name: travel-ollama-init
    depends_on:
      ollama-gpu:
        condition: service_healthy
        required: false
      ollama-cpu:
        condition: service_healthy
        required: false
    environment:
      - OLLAMA_HOST=travel-ollama:11434
      - OLLAMA_MODEL_ID=${OLLAMA_MODEL_ID:-qwen2.5:3b}
    volumes:
      - ./scripts/init-ollama.sh:/init-ollama.sh:ro
    entrypoint: ["/bin/bash", "/init-ollama.sh"]
    restart: "no"

  # ── MCP Server ──────────────────────────────────────────────
  mcp-server:
    build:
      context: ./mcp_server
      dockerfile: Dockerfile
    container_name: travel-mcp-server
    ports:
      - "8090:8090"
    environment:
      - OTEL_SERVICE_NAME=travel-mcp-tools
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://aspire-dashboard:18889
      - OTEL_EXPORTER_OTLP_PROTOCOL=grpc
      - OTEL_PYTHON_EXCLUDED_URLS=health
    depends_on:
      - aspire-dashboard
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8090/health')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

  # ── Aspire Dashboard (Traces + Metrics + Logs) ─────────────
  aspire-dashboard:
    image: mcr.microsoft.com/dotnet/aspire-dashboard:latest
    container_name: travel-aspire-dashboard
    ports:
      - "18888:18888"  # Aspire UI
      - "4317:18889"   # OTLP gRPC (host 4317 → container 18889)
      - "4318:18890"   # OTLP HTTP (host 4318 → container 18890)
    environment:
      - DOTNET_DASHBOARD_UNSECURED_ALLOW_ANONYMOUS=true
    restart: unless-stopped

  # ── PostgreSQL (Conversation Persistence) ───────────────────
  postgres:
    image: postgres:16-alpine
    container_name: travel-postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=travel
      - POSTGRES_PASSWORD=travel
      - POSTGRES_DB=travelplanner
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U travel -d travelplanner"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # ── FastAPI API Server ──────────────────────────────────────
  api:
    build:
      context: .
      dockerfile: api/Dockerfile
    container_name: travel-api
    ports:
      - "8000:8000"
    environment:
      - OLLAMA_HOST=http://travel-ollama:11434
      - OLLAMA_MODEL_ID=${OLLAMA_MODEL_ID:-qwen2.5:3b}
      - MCP_SERVER_URL=http://mcp-server:8090/mcp
      - DATABASE_URL=postgresql+asyncpg://travel:travel@postgres:5432/travelplanner
      - CORS_ORIGINS=http://localhost:3000
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://aspire-dashboard:18889
      - OTEL_EXPORTER_OTLP_PROTOCOL=grpc
      - OTEL_SERVICE_NAME=travel-planner-api
      - OTEL_PYTHON_EXCLUDED_URLS=health
    depends_on:
      mcp-server:
        condition: service_healthy
      postgres:
        condition: service_healthy
      aspire-dashboard:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # ── React / Next.js Frontend ────────────────────────────────
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: travel-frontend
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8000/api
    depends_on:
      api:
        condition: service_healthy
    restart: unless-stopped

# ── Volumes ───────────────────────────────────────────────────
volumes:
  ollama-models:
    name: travel-ollama-models
  postgres-data:
    name: travel-postgres-data
